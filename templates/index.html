<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunningHub å·¥ä½œæµæµè§ˆå™¨</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({id:"3NuKmEz9CSlS5YV5",ck:"3NuKmEz9CSlS5YV5"})</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .search-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-all-button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-all-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        .search-all-button:active {
            transform: translateY(0);
        }

        .page-limit-container {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }

        .page-limit-container.show {
            display: flex;
        }

        .page-limit-input {
            width: 80px;
            padding: 6px 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .page-limit-info {
            color: #666;
            font-size: 13px;
        }

        .search-hint {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-hint.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .search-hint.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .search-hint.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .search-history {
            position: absolute;
            top: 100%;
            left: 20px;
            right: 20px;
            margin-top: 5px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
        }

        .search-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .clear-history-btn {
            padding: 4px 12px;
            font-size: 12px;
            color: #f57c00;
            background: transparent;
            border: 1px solid #f57c00;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-history-btn:hover {
            background: #f57c00;
            color: white;
        }

        .search-history-list {
            max-height: 240px;
            overflow-y: auto;
        }

        .search-history-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .search-history-item:last-child {
            border-bottom: none;
        }

        .search-history-item:hover {
            background: #f5f5f5;
        }

        .search-history-keyword {
            font-size: 14px;
            color: #333;
        }

        .search-history-time {
            font-size: 12px;
            color: #999;
        }

        .search-history-empty {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 250px;
        }

        .controls select:hover {
            border-color: #667eea;
        }

        .controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .refresh-status {
            background: #f0f7ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .refresh-status.show {
            display: flex;
        }

        .refresh-status.success {
            background: #f0fff4;
            border-color: #9ae6b4;
        }

        .refresh-status.error {
            background: #fff5f5;
            border-color: #fc8181;
        }

        .refresh-progress {
            flex: 1;
        }

        .refresh-progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .refresh-progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .stats {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #667eea;
            font-size: 24px;
            font-weight: 700;
        }

        .sort-select {
            padding: 8px 16px;
            font-size: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        .sort-select:hover {
            border-color: #667eea;
        }

        .sort-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .loading {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workflows-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .workflow-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .workflow-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .workflow-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
            display: block;
            transition: opacity 0.3s ease;
        }

        .workflow-preview.lazy-loading {
            opacity: 0.3;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .workflow-preview.lazy-loaded {
            opacity: 1;
        }

        video.workflow-preview {
            cursor: pointer;
        }

        .workflow-content {
            padding: 20px;
        }

        .workflow-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .workflow-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .workflow-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 14px;
        }

        .workflow-stat-icon {
            font-size: 18px;
        }

        .workflow-stat-value {
            font-weight: 600;
            color: #333;
        }

        .workflow-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .workflow-link {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .workflow-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .workflow-link:active {
            transform: translateY(0);
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }

        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10000;
        }

        .image-modal-close:hover {
            color: #667eea;
            transform: scale(1.2);
        }

        .image-modal-caption {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            max-width: 80%;
        }

        .workflow-preview {
            cursor: pointer;
            transition: transform 0.3s;
        }

        .workflow-preview:hover {
            transform: scale(1.05);
        }

        .workflow-card:hover .workflow-preview {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .workflows-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ RunningHub å·¥ä½œæµæµè§ˆå™¨</h1>
            <p>æµè§ˆå’Œæ¢ç´¢ ComfyUI å·¥ä½œæµï¼ŒæŒ‰ç‚¹èµæ•°å’Œä½¿ç”¨æ¬¡æ•°æ’åº</p>
        </div>

        <!-- æœç´¢è¾“å…¥åŒºåŸŸ -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯ï¼Œå¦‚ï¼šæ¢è£…ã€é£æ ¼åŒ–ã€äººç‰©...">
                <button class="search-button" onclick="handleSearch()">ğŸ” æœç´¢</button>
                <button class="search-all-button" onclick="handleSearchAll()">ğŸ“š æœç´¢å…¨éƒ¨</button>
            </div>
            
            <!-- é¡µç é™åˆ¶è¾“å…¥ -->
            <div id="pageLimitContainer" class="page-limit-container">
                <span>æœ€å¤§é¡µæ•°ï¼š</span>
                <input type="number" id="pageLimitInput" class="page-limit-input" value="10" min="1" max="100">
                <span class="page-limit-info" id="pageLimitInfo">ï¼ˆæŸ¥è¯¢ä¸­...ï¼‰</span>
            </div>
            
            <!-- å†å²æœç´¢è®°å½• -->
            <div id="searchHistory" class="search-history" style="display: none;">
                <div class="search-history-header">
                    <span>ğŸ•’ å†å²æœç´¢</span>
                    <button class="clear-history-btn" onclick="clearSearchHistory()">æ¸…ç©º</button>
                </div>
                <div id="searchHistoryList" class="search-history-list"></div>
            </div>
            <div id="searchHint" class="search-hint" style="display: none;"></div>
        </div>

        <div class="controls" id="dataControls" style="display: none;">
            <label for="searchSelect">åˆ‡æ¢æœç´¢ï¼š</label>
            <select id="searchSelect">
                <option value="">é€‰æ‹©å·²æœ‰æœç´¢...</option>
            </select>
            <button id="refreshBtn" class="btn btn-primary">ğŸ”„ åˆ·æ–°å½“å‰æœç´¢</button>
        </div>

        <!-- åˆ·æ–°çŠ¶æ€æç¤º -->
        <div id="refreshStatus" class="refresh-status">
            <div class="refresh-progress">
                <div id="refreshMessage">æ­£åœ¨åˆ·æ–°æ•°æ®...</div>
                <div class="refresh-progress-bar">
                    <div id="refreshProgressFill" class="refresh-progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">æ€»å·¥ä½œæµæ•°ï¼š</span>
                <span class="stat-value" id="totalCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">è·å–æ—¶é—´ï¼š</span>
                <span class="stat-value" id="fetchTime" style="font-size: 16px;">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æ’åºæ–¹å¼ï¼š</span>
                <select id="sortSelect" class="sort-select" onchange="handleSortChange()">
                    <option value="likeCount">â¤ï¸ ç‚¹èµæ•°</option>
                    <option value="useCount">ğŸ”¥ ä½¿ç”¨æ•°</option>
                    <option value="collectCount" selected>â­ æ”¶è—æ•°</option>
                </select>
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡/è§†é¢‘é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" class="image-modal-content" onclick="event.stopPropagation()" style="display: none;">
        <video id="modalVideo" class="image-modal-content" muted controls onclick="event.stopPropagation()" style="display: none;">
            <source id="modalVideoSource" src="" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
        </video>
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        let currentData = null;
        let refreshCheckInterval = null;
        let currentSortBy = 'collectCount'; // é»˜è®¤æŒ‰æ”¶è—æ•°æ’åº
        let lazyLoadObserver = null; // æ‡’åŠ è½½è§‚å¯Ÿå™¨
        let renderedCards = new Set(); // å·²æ¸²æŸ“çš„å¡ç‰‡ç¼“å­˜
        let currentSearch = 'æ¢è£…'; // å½“å‰æœç´¢å…³é”®è¯
        let fetchCheckInterval = null; // æŠ“å–æ£€æŸ¥å®šæ—¶å™¨

        // æ‰“å¼€å›¾ç‰‡/è§†é¢‘é¢„è§ˆ
        function openImageModal(mediaSrc, caption = '') {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const modalVideoSource = document.getElementById('modalVideoSource');
            const modalCaption = document.getElementById('modalCaption');
            
            // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯è§†é¢‘
            const isVideo = mediaSrc.toLowerCase().endsWith('.mp4') || 
                           mediaSrc.toLowerCase().endsWith('.webm') || 
                           mediaSrc.toLowerCase().endsWith('.mov');
            
            if (isVideo) {
                // æ˜¾ç¤ºè§†é¢‘
                modalImg.style.display = 'none';
                modalVideo.style.display = 'block';
                modalVideoSource.src = mediaSrc;
                modalVideo.load();
                modalVideo.play();
            } else {
                // æ˜¾ç¤ºå›¾ç‰‡
                modalVideo.style.display = 'none';
                modalImg.style.display = 'block';
                modalImg.src = mediaSrc;
            }
            
            modal.className = 'image-modal show';
            modalCaption.textContent = caption;
            
            // é˜²æ­¢é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }

        // å…³é—­å›¾ç‰‡/è§†é¢‘é¢„è§ˆ
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const modalVideo = document.getElementById('modalVideo');
            
            // åœæ­¢è§†é¢‘æ’­æ”¾
            if (modalVideo.style.display !== 'none') {
                modalVideo.pause();
                modalVideo.currentTime = 0;
            }
            
            modal.className = 'image-modal';
            
            // æ¢å¤é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'auto';
        }

        // ESC é”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });

        // åˆå§‹åŒ–æ‡’åŠ è½½è§‚å¯Ÿå™¨
        function initLazyLoad() {
            if (lazyLoadObserver) {
                lazyLoadObserver.disconnect();
            }

            lazyLoadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        
                        if (element.tagName === 'IMG') {
                            const src = element.dataset.src;
                            if (src) {
                                element.classList.add('lazy-loading');
                                element.src = src;
                                element.onload = () => {
                                    element.classList.remove('lazy-loading');
                                    element.classList.add('lazy-loaded');
                                };
                                element.onerror = () => {
                                    element.classList.remove('lazy-loading');
                                    element.src = 'https://placehold.co/350x200?text=No+Preview';
                                };
                                delete element.dataset.src;
                            }
                        } else if (element.tagName === 'VIDEO') {
                            const src = element.dataset.src;
                            if (src) {
                                const source = element.querySelector('source');
                                if (source) {
                                    source.src = src;
                                    element.load();
                                    delete element.dataset.src;
                                }
                            }
                        }
                        
                        lazyLoadObserver.unobserve(element);
                    }
                });
            }, {
                rootMargin: '50px', // æå‰ 50px å¼€å§‹åŠ è½½
                threshold: 0.01
            });
        }

        // å¤„ç†æœç´¢
        async function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            const search = searchInput?.value?.trim();
            
            // éšè—å†å²è®°å½•
            hideSearchHistory();
            
            // ç©ºæœç´¢æ—¶ç»™å‡ºæç¤º
            if (!search) {
                showSearchHint('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼Œæˆ–ç‚¹å‡»"æœç´¢å…¨éƒ¨"æŒ‰é’®è·å–æ‰€æœ‰å·¥ä½œæµ', 'warning');
                return;
            }
            
            currentSearch = search;
            showSearchHint(`æ­£åœ¨æœç´¢ "${search}"...`, 'info');
            
            try {
                // ç©ºæœç´¢ä½¿ç”¨ç‰¹æ®Šè·¯å¾„ "all"
                const searchPath = search ? encodeURIComponent(search) : 'all';
                const response = await fetch(`/api/search/${searchPath}`);
                
                if (response.status === 202) {
                    // éœ€è¦æŠ“å–æ•°æ®
                    const result = await response.json();
                    showSearchHint(result.message, 'warning');
                    showFetchingUI();
                    
                    // ä¿å­˜æœç´¢å†å²ï¼ˆç©ºæœç´¢ä¿å­˜ä¸º"æ‰€æœ‰"ï¼‰
                    saveSearchHistory(search || 'æ‰€æœ‰');
                    
                    // è§¦å‘æŠ“å–
                    await triggerFetch(search);
                    
                    // å¼€å§‹è½®è¯¢æ£€æŸ¥
                    startFetchCheck(search);
                } else if (response.ok) {
                    // å·²æœ‰æ•°æ®
                    const data = await response.json();
                    currentData = data;
                    displayData(data);
                    showSearchHint(`æ‰¾åˆ° ${data.total_count} ä¸ªå·¥ä½œæµ`, 'success');
                    
                    // ä¿å­˜æœç´¢å†å²ï¼ˆç©ºæœç´¢ä¿å­˜ä¸º"æ‰€æœ‰"ï¼‰
                    saveSearchHistory(search || 'æ‰€æœ‰');
                    
                    // æ˜¾ç¤ºæ•°æ®æ§åˆ¶åŒºåŸŸå¹¶åŠ è½½æœç´¢åˆ—è¡¨
                    document.getElementById('dataControls').style.display = 'flex';
                    loadSearchList();
                } else {
                    throw new Error('æœç´¢å¤±è´¥');
                }
            } catch (error) {
                console.error('æœç´¢å‡ºé”™:', error);
                showSearchHint('æœç´¢å‡ºé”™: ' + error.message, 'warning');
            }
        }

        // å¤„ç†æœç´¢å…¨éƒ¨
        async function handleSearchAll() {
            // éšè—å†å²è®°å½•
            hideSearchHistory();
            
            // æ˜¾ç¤ºé¡µç é™åˆ¶è¾“å…¥
            const pageLimitContainer = document.getElementById('pageLimitContainer');
            pageLimitContainer.classList.add('show');
            
            // å…ˆæŸ¥è¯¢æ€»é¡µæ•°
            showSearchHint('æ­£åœ¨æŸ¥è¯¢å·¥ä½œæµæ€»æ•°...', 'info');
            await queryTotalPages();
            
            // è·å–ç”¨æˆ·è®¾ç½®çš„æœ€å¤§é¡µæ•°
            const maxPages = parseInt(document.getElementById('pageLimitInput').value) || 10;
            
            currentSearch = '';
            showSearchHint(`æ­£åœ¨æœç´¢æ‰€æœ‰å·¥ä½œæµï¼ˆæœ€å¤š ${maxPages} é¡µï¼‰...`, 'info');
            
            try {
                const response = await fetch(`/api/search/all`);
                
                if (response.status === 202) {
                    // éœ€è¦æŠ“å–æ•°æ®
                    const result = await response.json();
                    showSearchHint(result.message, 'warning');
                    showFetchingUI();
                    
                    // ä¿å­˜æœç´¢å†å²
                    saveSearchHistory('æ‰€æœ‰');
                    
                    // è§¦å‘æŠ“å–ï¼ˆå¸¦é¡µæ•°é™åˆ¶ï¼‰
                    await triggerFetchWithLimit('', maxPages);
                    
                    // å¼€å§‹è½®è¯¢æ£€æŸ¥
                    startFetchCheck('');
                } else if (response.ok) {
                    // å·²æœ‰æ•°æ®
                    const data = await response.json();
                    currentData = data;
                    displayData(data);
                    showSearchHint(`æ‰¾åˆ° ${data.total_count} ä¸ªå·¥ä½œæµ`, 'success');
                    
                    // ä¿å­˜æœç´¢å†å²
                    saveSearchHistory('æ‰€æœ‰');
                    
                    // æ˜¾ç¤ºæ•°æ®æ§åˆ¶åŒºåŸŸå¹¶åŠ è½½æœç´¢åˆ—è¡¨
                    document.getElementById('dataControls').style.display = 'flex';
                    loadSearchList();
                } else {
                    throw new Error('æœç´¢å¤±è´¥');
                }
            } catch (error) {
                console.error('æœç´¢å‡ºé”™:', error);
                showSearchHint('æœç´¢å‡ºé”™: ' + error.message, 'warning');
            }
        }

        // æŸ¥è¯¢æ€»é¡µæ•°
        async function queryTotalPages() {
            try {
                const response = await fetch('/api/total-pages');
                const result = await response.json();
                
                if (result.total_pages) {
                    const infoSpan = document.getElementById('pageLimitInfo');
                    infoSpan.textContent = `ï¼ˆå…±çº¦ ${result.total_pages} é¡µï¼Œ${result.total_count} ä¸ªå·¥ä½œæµï¼‰`;
                }
            } catch (error) {
                console.error('æŸ¥è¯¢æ€»é¡µæ•°å¤±è´¥:', error);
                document.getElementById('pageLimitInfo').textContent = 'ï¼ˆæŸ¥è¯¢å¤±è´¥ï¼‰';
            }
        }

        // è§¦å‘æŠ“å–ï¼ˆå¸¦é¡µæ•°é™åˆ¶ï¼‰
        async function triggerFetchWithLimit(search, maxPages) {
            try {
                const searchPath = search ? encodeURIComponent(search) : 'all';
                const response = await fetch(`/api/fetch/${searchPath}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ max_pages: maxPages })
                });
                const result = await response.json();
                console.log('è§¦å‘æŠ“å–:', result);
            } catch (error) {
                console.error('è§¦å‘æŠ“å–å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæœç´¢æç¤º
        function showSearchHint(message, type = 'info') {
            const hint = document.getElementById('searchHint');
            hint.textContent = message;
            hint.className = `search-hint ${type}`;
            hint.style.display = 'flex';
            
            // 3ç§’åè‡ªåŠ¨éšè—ï¼ˆé™¤éæ˜¯ warningï¼‰
            if (type !== 'warning') {
                setTimeout(() => {
                    hint.style.display = 'none';
                }, 3000);
            }
        }

        // æ˜¾ç¤ºæŠ“å–ä¸­çš„ UI
        function showFetchingUI() {
            const displaySearch = currentSearch || 'æ‰€æœ‰';
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨æŠ“å– "${displaySearch}" çš„æ•°æ®...</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">
                        è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…
                    </p>
                </div>
            `;
        }

        // è§¦å‘æŠ“å–
        async function triggerFetch(search) {
            try {
                // ç©ºæœç´¢ä½¿ç”¨ç‰¹æ®Šè·¯å¾„ "all"
                const searchPath = search ? encodeURIComponent(search) : 'all';
                const response = await fetch(`/api/fetch/${searchPath}`, {
                    method: 'POST'
                });
                const result = await response.json();
                console.log('è§¦å‘æŠ“å–:', result);
            } catch (error) {
                console.error('è§¦å‘æŠ“å–å¤±è´¥:', error);
            }
        }

        // å¼€å§‹è½®è¯¢æ£€æŸ¥æŠ“å–çŠ¶æ€
        function startFetchCheck(search) {
            if (fetchCheckInterval) {
                clearInterval(fetchCheckInterval);
            }
            
            fetchCheckInterval = setInterval(async () => {
                try {
                    // ç©ºæœç´¢ä½¿ç”¨ç‰¹æ®Šè·¯å¾„ "all"
                    const searchPath = search ? encodeURIComponent(search) : 'all';
                    const response = await fetch(`/api/search/${searchPath}`);
                    
                    if (response.ok) {
                        // æ•°æ®å·²å°±ç»ª
                        const data = await response.json();
                        if (data.workflows && data.workflows.length > 0) {
                            clearInterval(fetchCheckInterval);
                            fetchCheckInterval = null;
                            
                            currentData = data;
                            displayData(data);
                            showSearchHint(`æŠ“å–å®Œæˆï¼æ‰¾åˆ° ${data.total_count} ä¸ªå·¥ä½œæµ`, 'success');
                            
                            // æ˜¾ç¤ºæ•°æ®æ§åˆ¶åŒºåŸŸå¹¶åŠ è½½æœç´¢åˆ—è¡¨
                            document.getElementById('dataControls').style.display = 'flex';
                            loadSearchList();
                        }
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥æŠ“å–çŠ¶æ€å¤±è´¥:', error);
                }
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // å†å²æœç´¢è®°å½•ç®¡ç†
        const SEARCH_HISTORY_KEY = 'runninghub_search_history';
        const MAX_HISTORY = 10;

        // è·å–å†å²æœç´¢è®°å½•
        function getSearchHistory() {
            try {
                const history = localStorage.getItem(SEARCH_HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                return [];
            }
        }

        // ä¿å­˜æœç´¢è®°å½•
        function saveSearchHistory(keyword) {
            try {
                let history = getSearchHistory();
                
                // ç§»é™¤é‡å¤é¡¹
                history = history.filter(item => item.keyword !== keyword);
                
                // æ·»åŠ æ–°è®°å½•åˆ°å¼€å¤´
                history.unshift({
                    keyword: keyword,
                    time: new Date().toISOString()
                });
                
                // é™åˆ¶æ•°é‡
                if (history.length > MAX_HISTORY) {
                    history = history.slice(0, MAX_HISTORY);
                }
                
                localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('ä¿å­˜æœç´¢å†å²å¤±è´¥:', e);
            }
        }

        // æ¸…ç©ºæœç´¢å†å²
        function clearSearchHistory() {
            try {
                localStorage.removeItem(SEARCH_HISTORY_KEY);
                hideSearchHistory();
                showSearchHint('å†å²è®°å½•å·²æ¸…ç©º', 'success');
            } catch (e) {
                console.error('æ¸…ç©ºæœç´¢å†å²å¤±è´¥:', e);
            }
        }

        // æ˜¾ç¤ºå†å²æœç´¢è®°å½•
        function showSearchHistory() {
            const historyDiv = document.getElementById('searchHistory');
            const listDiv = document.getElementById('searchHistoryList');
            const history = getSearchHistory();
            
            if (history.length === 0) {
                listDiv.innerHTML = '<div class="search-history-empty">æš‚æ— æœç´¢å†å²</div>';
            } else {
                listDiv.innerHTML = history.map(item => {
                    const time = new Date(item.time);
                    const timeStr = formatTime(time);
                    return `
                        <div class="search-history-item" onclick="selectHistoryItem('${item.keyword.replace(/'/g, "\\'")}')">
                            <span class="search-history-keyword">${item.keyword}</span>
                            <span class="search-history-time">${timeStr}</span>
                        </div>
                    `;
                }).join('');
            }
            
            if (!historyDiv) {
                return;
            }
            historyDiv.style.display = 'block';
        }

        // éšè—å†å²æœç´¢è®°å½•
        function hideSearchHistory() {
            const historyDiv = document.getElementById('searchHistory');
            if (!historyDiv) {
                return;
            }
            historyDiv.style.display = 'none';
        }

        // é€‰æ‹©å†å²è®°å½•é¡¹
        function selectHistoryItem(keyword) {
            const searchInput = document.getElementById('searchInput');
            // "æ‰€æœ‰"å¯¹åº”ç©ºæœç´¢
            searchInput.value = keyword === 'æ‰€æœ‰' ? '' : keyword;
            hideSearchHistory();
            handleSearch();
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'åˆšåˆš';
            if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
            if (hours < 24) return `${hours}å°æ—¶å‰`;
            if (days < 7) return `${days}å¤©å‰`;
            
            return date.toLocaleDateString('zh-CN', { 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // å›è½¦æœç´¢å’Œäº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            
            // å›è½¦æœç´¢
            searchInput?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // èšç„¦æ˜¾ç¤ºå†å²
            searchInput?.addEventListener('focus', () => {
                showSearchHistory();
            });
            
            // ç‚¹å‡»å¤–éƒ¨éšè—å†å²
            document.addEventListener('click', (e) => {
                const searchContainer = document.querySelector('.search-container');
                if (!searchContainer.contains(e.target)) {
                    hideSearchHistory();
                }
            });
        });

        // åŠ è½½æœç´¢åˆ—è¡¨
        async function loadSearchList() {
            try {
                const response = await fetch('/api/searches');
                const searches = await response.json();
                
                const select = document.getElementById('searchSelect');
                select.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰æœç´¢...</option>';
                
                if (searches.length === 0) {
                    return;
                }
                
                searches.forEach(item => {
                    const option = document.createElement('option');
                    // "all" æ–‡ä»¶å¤¹å¯¹åº”ç©ºæœç´¢
                    const isAll = item.keyword === 'all';
                    option.value = isAll ? '' : item.keyword;
                    const displayName = isAll ? 'æ‰€æœ‰' : item.keyword;
                    option.textContent = `${displayName} (${item.count}ä¸ª)`;
                    
                    // æ ‡è®°å½“å‰é€‰ä¸­çš„æœç´¢
                    const currentKey = currentSearch || 'all';
                    if (item.keyword === currentKey) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½æœç´¢åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                
                const select = document.getElementById('fileSelect');
                if (!select) {
                    console.log('fileSelect å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½');
                    return;
                }
                
                select.innerHTML = '';
                
                if (files.length === 0) {
                    select.innerHTML = '<option value="">æ²¡æœ‰å¯ç”¨æ•°æ®</option>';
                    return;
                }
                
                files.forEach((file, index) => {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = `${file.timestamp}${index === 0 ? ' (æœ€æ–°)' : ''}`;
                    select.appendChild(option);
                });
                
                // ä¸å†è‡ªåŠ¨åŠ è½½ï¼Œé€šè¿‡æœç´¢åŠŸèƒ½åŠ è½½æ•°æ®
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                // ä¸åœ¨å†…å®¹åŒºåŸŸæ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…è¦†ç›–æç¤ºä¿¡æ¯
            }
        }

        // åŠ è½½æœ€æ–°æ•°æ®
        async function loadLatestData() {
            try {
                const response = await fetch('/api/latest');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentData = data;
                displayData(data);
            } catch (error) {
                console.error('åŠ è½½æœ€æ–°æ•°æ®å¤±è´¥:', error);
                document.getElementById('content').innerHTML = 
                    '<div class="error">åŠ è½½æ•°æ®å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åŠ è½½æŒ‡å®šæ–‡ä»¶
        async function loadFile(filename) {
            try {
                document.getElementById('content').innerHTML = 
                    '<div class="loading"><div class="loading-spinner"></div><p>æ­£åœ¨åŠ è½½æ•°æ®...</p></div>';
                
                const response = await fetch('/api/data/' + filename);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentData = data;
                displayData(data);
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
                document.getElementById('content').innerHTML = 
                    '<div class="error">åŠ è½½æ•°æ®å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ˜¾ç¤ºæ•°æ®
        function displayData(data, sortBy = currentSortBy) {
            const startTime = performance.now(); // æ€§èƒ½ç›‘æ§
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæœ€æ–°è·å–çš„æ•°æ®ï¼‰
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('totalCount').textContent = data.total_count || 0;
            
            // æ˜¾ç¤ºæ•°æ®è·å–æ—¶é—´ï¼ˆæœ€æ–°æ•°æ®ï¼‰
            const fetchTime = new Date(data.fetch_time);
            const now = new Date();
            const isRecent = (now - fetchTime) < 60000; // 1åˆ†é’Ÿå†…
            
            let timeText = fetchTime.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // å¦‚æœæ˜¯åˆšè·å–çš„æ•°æ®ï¼Œæ·»åŠ æ ‡è¯†
            if (isRecent) {
                timeText += ' (æœ€æ–°)';
            }
            
            document.getElementById('fetchTime').textContent = timeText;
            
            // æ˜¾ç¤ºå·¥ä½œæµï¼ˆæ’åºï¼‰
            let workflows = data.workflows || [];
            
            // æ ¹æ®é€‰æ‹©çš„ç»´åº¦æ’åº
            workflows = [...workflows].sort((a, b) => {
                const aValue = a.statisticsInfo?.[sortBy] || 0;
                const bValue = b.statisticsInfo?.[sortBy] || 0;
                return bValue - aValue; // é™åºæ’åˆ—
            });
            
            // ä½¿ç”¨ DocumentFragment æ‰¹é‡æ¸²æŸ“ï¼Œæå‡æ€§èƒ½
            const grid = document.createElement('div');
            grid.className = 'workflows-grid';
            const fragment = document.createDocumentFragment();
            
            workflows.forEach(workflow => {
                const card = createWorkflowCard(workflow);
                fragment.appendChild(card);
            });
            
            grid.appendChild(fragment);
            
            document.getElementById('content').innerHTML = '';
            document.getElementById('content').appendChild(grid);
            
            // åˆå§‹åŒ–æ‡’åŠ è½½
            initLazyLoad();
            
            // è§‚å¯Ÿæ‰€æœ‰éœ€è¦æ‡’åŠ è½½çš„å…ƒç´ 
            const lazyElements = grid.querySelectorAll('[data-src]');
            lazyElements.forEach(el => lazyLoadObserver.observe(el));
            
            // æ€§èƒ½ç›‘æ§è¾“å‡º
            const endTime = performance.now();
            const renderTime = (endTime - startTime).toFixed(2);
            console.log(`âœ… æ¸²æŸ“å®Œæˆ: ${workflows.length} ä¸ªå·¥ä½œæµ, è€—æ—¶ ${renderTime}ms`);
            console.log(`ğŸ–¼ï¸  æ‡’åŠ è½½å…ƒç´ : ${lazyElements.length} ä¸ª`);
        }

        // å¤„ç†æ’åºå˜åŒ–
        function handleSortChange() {
            const sortSelect = document.getElementById('sortSelect');
            currentSortBy = sortSelect.value;
            
            if (currentData) {
                displayData(currentData, currentSortBy);
            }
        }

        // åˆ›å»ºå·¥ä½œæµå¡ç‰‡
        function createWorkflowCard(item) {
            const card = document.createElement('div');
            card.className = 'workflow-card';
            
            const preview = item.covers?.[0] || {};
            const stats = item.statisticsInfo || {};
            
            const previewUrl = preview.url || 'https://placehold.co/350x200?text=No+Preview';
            const workflowName = (item.name || 'æœªå‘½åå·¥ä½œæµ').replace(/'/g, "\\'");
            
            // åˆ¤æ–­æ˜¯è§†é¢‘è¿˜æ˜¯å›¾ç‰‡
            const isVideo = previewUrl.toLowerCase().endsWith('.mp4') || 
                           previewUrl.toLowerCase().endsWith('.webm') || 
                           previewUrl.toLowerCase().endsWith('.mov');
            
            let previewHtml;
            if (isVideo) {
                // è§†é¢‘é¢„è§ˆï¼ˆä½¿ç”¨ poster ä½œä¸ºå°é¢ï¼Œå¦‚æœæœ‰ thumbnailUriï¼‰
                const posterUrl = preview.thumbnailUri || '';
                previewHtml = `
                    <video class="workflow-preview" 
                           ${posterUrl ? `poster="${posterUrl}"` : ''}
                           data-src="${previewUrl}"
                           muted 
                           loop
                           onclick="openImageModal('${previewUrl}', '${workflowName}')"
                           onmouseover="this.play()" 
                           onmouseout="this.pause(); this.currentTime=0;">
                        <source type="video/mp4">
                    </video>`;
            } else {
                // å›¾ç‰‡é¢„è§ˆï¼ˆæ‡’åŠ è½½ï¼‰
                previewHtml = `
                    <img data-src="${previewUrl}" 
                         alt="${workflowName}" 
                         class="workflow-preview lazy-loading" 
                         onclick="openImageModal('${previewUrl}', '${workflowName}')">`;
            }
            
            card.innerHTML = `
                ${previewHtml}
                <div class="workflow-content">
                    <div class="workflow-name">${item.name || 'æœªå‘½åå·¥ä½œæµ'}</div>
                    <div class="workflow-stats">
                        <div class="workflow-stat">
                            <span class="workflow-stat-icon">â¤ï¸</span>
                            <span class="workflow-stat-value">${stats.likeCount || 0}</span>
                        </div>
                        <div class="workflow-stat">
                            <span class="workflow-stat-icon">ğŸ”¥</span>
                            <span class="workflow-stat-value">${stats.useCount || 0}</span>
                        </div>
                        <div class="workflow-stat">
                            <span class="workflow-stat-icon">â­</span>
                            <span class="workflow-stat-value">${stats.collectCount || 0}</span>
                        </div>
                    </div>
                    <div class="workflow-actions">
                        <a href="https://www.runninghub.cn/post/${item.id}" 
                           target="_blank" 
                           class="workflow-link">æŸ¥çœ‹è¯¦æƒ…</a>
                        <a href="https://www.runninghub.cn/workflow/${item.id}" 
                           target="_blank" 
                           class="workflow-link">è¿è¡Œå·¥ä½œæµ</a>
                        <a href="javascript:void(0)" 
                           onclick="downloadWorkflow('${item.id}', '${(item.name || 'æœªå‘½åå·¥ä½œæµ').replace(/'/g, "\\'")}')"
                           class="workflow-link">ä¿å­˜å·¥ä½œæµ</a>
                    </div>
                </div>
            `;
            
            return card;
        }

        // ä¸‹è½½å·¥ä½œæµ
        async function downloadWorkflow(workflowId, workflowName) {
            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                const statusDiv = document.getElementById('refreshStatus');
                const messageDiv = document.getElementById('refreshMessage');
                statusDiv.className = 'refresh-status show';
                messageDiv.textContent = 'æ­£åœ¨è·å–å·¥ä½œæµæ•°æ®...';
                
                // è·å–å·¥ä½œæµè¯¦æƒ…
                const response = await fetch('/api/workflow/' + workflowId);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // è§£æ workflowContent
                let workflowContent;
                if (typeof data.workflowContent === 'string') {
                    workflowContent = JSON.parse(data.workflowContent);
                } else {
                    workflowContent = data.workflowContent;
                }
                
                // åˆ›å»ºä¸‹è½½
                const blob = new Blob([JSON.stringify(workflowContent, null, 2)], { 
                    type: 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${workflowName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                statusDiv.className = 'refresh-status show success';
                messageDiv.textContent = 'âœ“ å·¥ä½œæµå·²ä¿å­˜';
                
                // 3ç§’åéšè—
                setTimeout(() => {
                    statusDiv.className = 'refresh-status';
                }, 3000);
                
            } catch (error) {
                console.error('ä¸‹è½½å·¥ä½œæµå¤±è´¥:', error);
                const statusDiv = document.getElementById('refreshStatus');
                const messageDiv = document.getElementById('refreshMessage');
                statusDiv.className = 'refresh-status show error';
                messageDiv.textContent = 'ä¸‹è½½å¤±è´¥: ' + error.message;
                
                // 3ç§’åéšè—
                setTimeout(() => {
                    statusDiv.className = 'refresh-status';
                }, 3000);
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const statusDiv = document.getElementById('refreshStatus');
            const messageDiv = document.getElementById('refreshMessage');
            const progressFill = document.getElementById('refreshProgressFill');
            
            try {
                // ç¦ç”¨æŒ‰é’®
                btn.disabled = true;
                
                // æ˜¾ç¤ºåˆ·æ–°çŠ¶æ€
                statusDiv.className = 'refresh-status show';
                messageDiv.textContent = 'æ­£åœ¨å¯åŠ¨æ•°æ®åˆ·æ–°...';
                progressFill.style.width = '0%';
                
                // è§¦å‘åˆ·æ–°
                const response = await fetch('/api/refresh', { method: 'POST' });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                messageDiv.textContent = 'æ•°æ®åˆ·æ–°å·²å¼€å§‹...';
                
                // å¼€å§‹è½®è¯¢åˆ·æ–°çŠ¶æ€
                refreshCheckInterval = setInterval(checkRefreshStatus, 1000);
                
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                statusDiv.className = 'refresh-status show error';
                messageDiv.textContent = 'åˆ·æ–°å¤±è´¥: ' + error.message;
                btn.disabled = false;
            }
        }

        // æ£€æŸ¥åˆ·æ–°çŠ¶æ€
        async function checkRefreshStatus() {
            try {
                const response = await fetch('/api/refresh/status');
                const status = await response.json();
                
                const statusDiv = document.getElementById('refreshStatus');
                const messageDiv = document.getElementById('refreshMessage');
                const progressFill = document.getElementById('refreshProgressFill');
                const btn = document.getElementById('refreshBtn');
                
                if (status.error) {
                    // åˆ·æ–°å‡ºé”™
                    clearInterval(refreshCheckInterval);
                    statusDiv.className = 'refresh-status show error';
                    messageDiv.textContent = 'åˆ·æ–°å¤±è´¥: ' + status.error;
                    btn.disabled = false;
                    
                    // 3ç§’åéšè—
                    setTimeout(() => {
                        statusDiv.className = 'refresh-status';
                    }, 3000);
                    
                } else if (!status.is_running && status.message.includes('å®Œæˆ')) {
                    // åˆ·æ–°å®Œæˆ
                    clearInterval(refreshCheckInterval);
                    statusDiv.className = 'refresh-status show success';
                    messageDiv.textContent = `âœ“ "${currentSearch}" æ•°æ®åˆ·æ–°å®Œæˆ`;
                    progressFill.style.width = '100%';
                    btn.disabled = false;
                    
                    // é‡æ–°åŠ è½½å½“å‰æœç´¢çš„æ•°æ®
                    const searchPath = currentSearch ? encodeURIComponent(currentSearch) : 'all';
                    const response = await fetch(`/api/search/${searchPath}`);
                    if (response.ok) {
                        const data = await response.json();
                        currentData = data;
                        displayData(data);
                        loadSearchList(); // æ›´æ–°æœç´¢åˆ—è¡¨
                    }
                    
                    // 3ç§’åéšè—
                    setTimeout(() => {
                        statusDiv.className = 'refresh-status';
                    }, 3000);
                    
                } else if (status.is_running) {
                    // åˆ·æ–°è¿›è¡Œä¸­
                    messageDiv.textContent = status.message;
                    if (status.total > 0) {
                        const progress = (status.current / status.total) * 100;
                        progressFill.style.width = progress + '%';
                    }
                }
                
            } catch (error) {
                console.error('æ£€æŸ¥åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('searchSelect').addEventListener('change', (e) => {
            const keyword = e.target.value;
            if (keyword) {
                // åˆ‡æ¢åˆ°é€‰ä¸­çš„æœç´¢
                document.getElementById('searchInput').value = keyword;
                handleSearch();
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            // åˆ·æ–°å½“å‰æœç´¢çš„æ•°æ®
            if (!currentSearch) {
                showSearchHint('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœç´¢å…³é”®è¯', 'warning');
                return;
            }
            
            const btn = document.getElementById('refreshBtn');
            const statusDiv = document.getElementById('refreshStatus');
            const messageDiv = document.getElementById('refreshMessage');
            const progressFill = document.getElementById('refreshProgressFill');
            
            try {
                // ç¦ç”¨æŒ‰é’®
                btn.disabled = true;
                
                // æ˜¾ç¤ºåˆ·æ–°çŠ¶æ€
                statusDiv.className = 'refresh-status show';
                messageDiv.textContent = `æ­£åœ¨åˆ·æ–° "${currentSearch}" çš„æ•°æ®...`;
                progressFill.style.width = '0%';
                
                // è§¦å‘æŠ“å–
                await triggerFetch(currentSearch);
                
                // å¼€å§‹è½®è¯¢åˆ·æ–°çŠ¶æ€
                refreshCheckInterval = setInterval(checkRefreshStatus, 1000);
                
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                statusDiv.className = 'refresh-status show error';
                messageDiv.textContent = 'åˆ·æ–°å¤±è´¥: ' + error.message;
                btn.disabled = false;
            }
        });

        // åˆå§‹åŒ–
        async function initPage() {
            // æ¸…ç©ºå†…å®¹åŒºåŸŸ
            document.getElementById('content').innerHTML = '';
            
            // åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼ˆä¸æ˜¾ç¤ºå†…å®¹ï¼‰
            loadFileList();
            
            // æ˜¾ç¤ºé¡µç é™åˆ¶å®¹å™¨
            document.getElementById('pageLimitContainer').classList.add('show');
            
            // æŸ¥è¯¢æ€»é¡µæ•°å¹¶æ˜¾ç¤º
            await queryTotalPages();
            
            // æ˜¾ç¤ºæç¤º
            showSearchHint('è¯·è¾“å…¥å…³é”®è¯æœç´¢ï¼Œæˆ–ç‚¹å‡»"æœç´¢å…¨éƒ¨"è·å–æ‰€æœ‰å·¥ä½œæµ', 'warning');
        }
        
        initPage();
    </script>
</body>
</html>
