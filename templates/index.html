<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunningHub 工作流浏览器</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({id:"3NuKmEz9CSlS5YV5",ck:"3NuKmEz9CSlS5YV5"})</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .search-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-all-button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-all-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        .search-all-button:active {
            transform: translateY(0);
        }

        .page-limit-container {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }

        .page-limit-container.show {
            display: flex;
        }

        .page-limit-input {
            width: 80px;
            padding: 6px 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .page-limit-info {
            color: #666;
            font-size: 13px;
        }

        .search-hint {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-hint.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .search-hint.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .search-hint.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .search-history {
            position: absolute;
            top: 100%;
            left: 20px;
            right: 20px;
            margin-top: 5px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
        }

        .search-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .clear-history-btn {
            padding: 4px 12px;
            font-size: 12px;
            color: #f57c00;
            background: transparent;
            border: 1px solid #f57c00;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-history-btn:hover {
            background: #f57c00;
            color: white;
        }

        .search-history-list {
            max-height: 240px;
            overflow-y: auto;
        }

        .search-history-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .search-history-item:last-child {
            border-bottom: none;
        }

        .search-history-item:hover {
            background: #f5f5f5;
        }

        .search-history-keyword {
            font-size: 14px;
            color: #333;
        }

        .search-history-time {
            font-size: 12px;
            color: #999;
        }

        .search-history-empty {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 250px;
        }

        .controls select:hover {
            border-color: #667eea;
        }

        .controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .refresh-status {
            background: #f0f7ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .refresh-status.show {
            display: flex;
        }

        .refresh-status.success {
            background: #f0fff4;
            border-color: #9ae6b4;
        }

        .refresh-status.error {
            background: #fff5f5;
            border-color: #fc8181;
        }

        .refresh-progress {
            flex: 1;
        }

        .refresh-progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .refresh-progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .stats {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #667eea;
            font-size: 24px;
            font-weight: 700;
        }

        .sort-select {
            padding: 8px 16px;
            font-size: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        .sort-select:hover {
            border-color: #667eea;
        }

        .sort-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .loading {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workflows-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .workflow-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .workflow-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .workflow-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
            display: block;
            transition: opacity 0.3s ease;
        }

        .workflow-preview.lazy-loading {
            opacity: 0.3;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .workflow-preview.lazy-loaded {
            opacity: 1;
        }

        video.workflow-preview {
            cursor: pointer;
        }

        .workflow-content {
            padding: 20px;
        }

        .workflow-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .workflow-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .workflow-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 14px;
        }

        .workflow-stat-icon {
            font-size: 18px;
        }

        .workflow-stat-value {
            font-weight: 600;
            color: #333;
        }

        .workflow-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .workflow-link {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .workflow-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .workflow-link:active {
            transform: translateY(0);
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 图片预览模态框 */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }

        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10000;
        }

        .image-modal-close:hover {
            color: #667eea;
            transform: scale(1.2);
        }

        .image-modal-caption {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            max-width: 80%;
        }

        .workflow-preview {
            cursor: pointer;
            transition: transform 0.3s;
        }

        .workflow-preview:hover {
            transform: scale(1.05);
        }

        .workflow-card:hover .workflow-preview {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .workflows-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 RunningHub 工作流浏览器</h1>
            <p>浏览和探索 ComfyUI 工作流，按点赞数和使用次数排序</p>
        </div>

        <!-- 搜索输入区域 -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="输入搜索关键词，如：换装、风格化、人物...">
                <button class="search-button" onclick="handleSearch()">🔍 搜索</button>
                <button class="search-all-button" onclick="handleSearchAll()">📚 搜索全部</button>
            </div>
            
            <!-- 页码限制输入 -->
            <div id="pageLimitContainer" class="page-limit-container">
                <span>最大页数：</span>
                <input type="number" id="pageLimitInput" class="page-limit-input" value="10" min="1" max="100">
                <span class="page-limit-info" id="pageLimitInfo">（查询中...）</span>
            </div>
            
            <!-- 历史搜索记录 -->
            <div id="searchHistory" class="search-history" style="display: none;">
                <div class="search-history-header">
                    <span>🕒 历史搜索</span>
                    <button class="clear-history-btn" onclick="clearSearchHistory()">清空</button>
                </div>
                <div id="searchHistoryList" class="search-history-list"></div>
            </div>
            <div id="searchHint" class="search-hint" style="display: none;"></div>
        </div>

        <div class="controls" id="dataControls" style="display: none;">
            <label for="searchSelect">切换搜索：</label>
            <select id="searchSelect">
                <option value="">选择已有搜索...</option>
            </select>
            <button id="refreshBtn" class="btn btn-primary">🔄 刷新当前搜索</button>
        </div>

        <!-- 刷新状态提示 -->
        <div id="refreshStatus" class="refresh-status">
            <div class="refresh-progress">
                <div id="refreshMessage">正在刷新数据...</div>
                <div class="refresh-progress-bar">
                    <div id="refreshProgressFill" class="refresh-progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">总工作流数：</span>
                <span class="stat-value" id="totalCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">获取时间：</span>
                <span class="stat-value" id="fetchTime" style="font-size: 16px;">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">排序方式：</span>
                <select id="sortSelect" class="sort-select" onchange="handleSortChange()">
                    <option value="likeCount">❤️ 点赞数</option>
                    <option value="useCount">🔥 使用数</option>
                    <option value="collectCount" selected>⭐ 收藏数</option>
                </select>
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>正在加载数据...</p>
            </div>
        </div>
    </div>

    <!-- 图片/视频预览模态框 -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" class="image-modal-content" onclick="event.stopPropagation()" style="display: none;">
        <video id="modalVideo" class="image-modal-content" muted controls onclick="event.stopPropagation()" style="display: none;">
            <source id="modalVideoSource" src="" type="video/mp4">
            您的浏览器不支持视频播放
        </video>
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        let currentData = null;
        let refreshCheckInterval = null;
        let currentSortBy = 'collectCount'; // 默认按收藏数排序
        let lazyLoadObserver = null; // 懒加载观察器
        let renderedCards = new Set(); // 已渲染的卡片缓存
        let currentSearch = '换装'; // 当前搜索关键词
        let fetchCheckInterval = null; // 抓取检查定时器

        // 打开图片/视频预览
        function openImageModal(mediaSrc, caption = '') {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const modalVideoSource = document.getElementById('modalVideoSource');
            const modalCaption = document.getElementById('modalCaption');
            
            // 判断是图片还是视频
            const isVideo = mediaSrc.toLowerCase().endsWith('.mp4') || 
                           mediaSrc.toLowerCase().endsWith('.webm') || 
                           mediaSrc.toLowerCase().endsWith('.mov');
            
            if (isVideo) {
                // 显示视频
                modalImg.style.display = 'none';
                modalVideo.style.display = 'block';
                modalVideoSource.src = mediaSrc;
                modalVideo.load();
                modalVideo.play();
            } else {
                // 显示图片
                modalVideo.style.display = 'none';
                modalImg.style.display = 'block';
                modalImg.src = mediaSrc;
            }
            
            modal.className = 'image-modal show';
            modalCaption.textContent = caption;
            
            // 防止页面滚动
            document.body.style.overflow = 'hidden';
        }

        // 关闭图片/视频预览
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const modalVideo = document.getElementById('modalVideo');
            
            // 停止视频播放
            if (modalVideo.style.display !== 'none') {
                modalVideo.pause();
                modalVideo.currentTime = 0;
            }
            
            modal.className = 'image-modal';
            
            // 恢复页面滚动
            document.body.style.overflow = 'auto';
        }

        // ESC 键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });

        // 初始化懒加载观察器
        function initLazyLoad() {
            if (lazyLoadObserver) {
                lazyLoadObserver.disconnect();
            }

            lazyLoadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        
                        if (element.tagName === 'IMG') {
                            const src = element.dataset.src;
                            if (src) {
                                element.classList.add('lazy-loading');
                                element.src = src;
                                element.onload = () => {
                                    element.classList.remove('lazy-loading');
                                    element.classList.add('lazy-loaded');
                                };
                                element.onerror = () => {
                                    element.classList.remove('lazy-loading');
                                    element.src = 'https://placehold.co/350x200?text=No+Preview';
                                };
                                delete element.dataset.src;
                            }
                        } else if (element.tagName === 'VIDEO') {
                            const src = element.dataset.src;
                            if (src) {
                                const source = element.querySelector('source');
                                if (source) {
                                    source.src = src;
                                    element.load();
                                    delete element.dataset.src;
                                }
                            }
                        }
                        
                        lazyLoadObserver.unobserve(element);
                    }
                });
            }, {
                rootMargin: '50px', // 提前 50px 开始加载
                threshold: 0.01
            });
        }

        // 处理搜索
        async function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            const search = searchInput?.value?.trim();
            
            // 隐藏历史记录
            hideSearchHistory();
            
            // 空搜索时给出提示
            if (!search) {
                showSearchHint('请输入搜索关键词，或点击"搜索全部"按钮获取所有工作流', 'warning');
                return;
            }
            
            currentSearch = search;
            showSearchHint(`正在搜索 "${search}"...`, 'info');
            
            try {
                // 空搜索使用特殊路径 "all"
                const searchPath = search ? encodeURIComponent(search) : 'all';
                const response = await fetch(`/api/search/${searchPath}`);
                
                if (response.status === 202) {
                    // 需要抓取数据
                    const result = await response.json();
                    showSearchHint(result.message, 'warning');
                    showFetchingUI();
                    
                    // 保存搜索历史（空搜索保存为"所有"）
                    saveSearchHistory(search || '所有');
                    
                    // 触发抓取
                    await triggerFetch(search);
                    
                    // 开始轮询检查
                    startFetchCheck(search);
                } else if (response.ok) {
                    // 已有数据
                    const data = await response.json();
                    currentData = data;
                    displayData(data);
                    showSearchHint(`找到 ${data.total_count} 个工作流`, 'success');
                    
                    // 保存搜索历史（空搜索保存为"所有"）
                    saveSearchHistory(search || '所有');
                    
                    // 显示数据控制区域并加载搜索列表
                    document.getElementById('dataControls').style.display = 'flex';
                    loadSearchList();
                } else {
                    throw new Error('搜索失败');
                }
            } catch (error) {
                console.error('搜索出错:', error);
                showSearchHint('搜索出错: ' + error.message, 'warning');
            }
        }

        // 处理搜索全部
        async function handleSearchAll() {
            // 隐藏历史记录
            hideSearchHistory();
            
            // 显示页码限制输入
            const pageLimitContainer = document.getElementById('pageLimitContainer');
            pageLimitContainer.classList.add('show');
            
            // 先查询总页数
            showSearchHint('正在查询工作流总数...', 'info');
            await queryTotalPages();
            
            // 获取用户设置的最大页数
            const maxPages = parseInt(document.getElementById('pageLimitInput').value) || 10;
            
            currentSearch = '';
            showSearchHint(`正在搜索所有工作流（最多 ${maxPages} 页）...`, 'info');
            
            try {
                const response = await fetch(`/api/search/all`);
                
                if (response.status === 202) {
                    // 需要抓取数据
                    const result = await response.json();
                    showSearchHint(result.message, 'warning');
                    showFetchingUI();
                    
                    // 保存搜索历史
                    saveSearchHistory('所有');
                    
                    // 触发抓取（带页数限制）
                    await triggerFetchWithLimit('', maxPages);
                    
                    // 开始轮询检查
                    startFetchCheck('');
                } else if (response.ok) {
                    // 已有数据
                    const data = await response.json();
                    currentData = data;
                    displayData(data);
                    showSearchHint(`找到 ${data.total_count} 个工作流`, 'success');
                    
                    // 保存搜索历史
                    saveSearchHistory('所有');
                    
                    // 显示数据控制区域并加载搜索列表
                    document.getElementById('dataControls').style.display = 'flex';
                    loadSearchList();
                } else {
                    throw new Error('搜索失败');
                }
            } catch (error) {
                console.error('搜索出错:', error);
                showSearchHint('搜索出错: ' + error.message, 'warning');
            }
        }

        // 查询总页数
        async function queryTotalPages() {
            try {
                const response = await fetch('/api/total-pages');
                const result = await response.json();
                
                if (result.total_pages) {
                    const infoSpan = document.getElementById('pageLimitInfo');
                    infoSpan.textContent = `（共约 ${result.total_pages} 页，${result.total_count} 个工作流）`;
                }
            } catch (error) {
                console.error('查询总页数失败:', error);
                document.getElementById('pageLimitInfo').textContent = '（查询失败）';
            }
        }

        // 触发抓取（带页数限制）
        async function triggerFetchWithLimit(search, maxPages) {
            try {
                const searchPath = search ? encodeURIComponent(search) : 'all';
                const response = await fetch(`/api/fetch/${searchPath}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ max_pages: maxPages })
                });
                const result = await response.json();
                console.log('触发抓取:', result);
            } catch (error) {
                console.error('触发抓取失败:', error);
            }
        }

        // 显示搜索提示
        function showSearchHint(message, type = 'info') {
            const hint = document.getElementById('searchHint');
            hint.textContent = message;
            hint.className = `search-hint ${type}`;
            hint.style.display = 'flex';
            
            // 3秒后自动隐藏（除非是 warning）
            if (type !== 'warning') {
                setTimeout(() => {
                    hint.style.display = 'none';
                }, 3000);
            }
        }

        // 显示抓取中的 UI
        function showFetchingUI() {
            const displaySearch = currentSearch || '所有';
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>正在抓取 "${displaySearch}" 的数据...</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">
                        这可能需要几分钟时间，请耐心等待
                    </p>
                </div>
            `;
        }

        // 触发抓取
        async function triggerFetch(search) {
            try {
                // 空搜索使用特殊路径 "all"
                const searchPath = search ? encodeURIComponent(search) : 'all';
                const response = await fetch(`/api/fetch/${searchPath}`, {
                    method: 'POST'
                });
                const result = await response.json();
                console.log('触发抓取:', result);
            } catch (error) {
                console.error('触发抓取失败:', error);
            }
        }

        // 开始轮询检查抓取状态
        function startFetchCheck(search) {
            if (fetchCheckInterval) {
                clearInterval(fetchCheckInterval);
            }
            
            fetchCheckInterval = setInterval(async () => {
                try {
                    // 空搜索使用特殊路径 "all"
                    const searchPath = search ? encodeURIComponent(search) : 'all';
                    const response = await fetch(`/api/search/${searchPath}`);
                    
                    if (response.ok) {
                        // 数据已就绪
                        const data = await response.json();
                        if (data.workflows && data.workflows.length > 0) {
                            clearInterval(fetchCheckInterval);
                            fetchCheckInterval = null;
                            
                            currentData = data;
                            displayData(data);
                            showSearchHint(`抓取完成！找到 ${data.total_count} 个工作流`, 'success');
                            
                            // 显示数据控制区域并加载搜索列表
                            document.getElementById('dataControls').style.display = 'flex';
                            loadSearchList();
                        }
                    }
                } catch (error) {
                    console.error('检查抓取状态失败:', error);
                }
            }, 5000); // 每5秒检查一次
        }

        // 历史搜索记录管理
        const SEARCH_HISTORY_KEY = 'runninghub_search_history';
        const MAX_HISTORY = 10;

        // 获取历史搜索记录
        function getSearchHistory() {
            try {
                const history = localStorage.getItem(SEARCH_HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                return [];
            }
        }

        // 保存搜索记录
        function saveSearchHistory(keyword) {
            try {
                let history = getSearchHistory();
                
                // 移除重复项
                history = history.filter(item => item.keyword !== keyword);
                
                // 添加新记录到开头
                history.unshift({
                    keyword: keyword,
                    time: new Date().toISOString()
                });
                
                // 限制数量
                if (history.length > MAX_HISTORY) {
                    history = history.slice(0, MAX_HISTORY);
                }
                
                localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('保存搜索历史失败:', e);
            }
        }

        // 清空搜索历史
        function clearSearchHistory() {
            try {
                localStorage.removeItem(SEARCH_HISTORY_KEY);
                hideSearchHistory();
                showSearchHint('历史记录已清空', 'success');
            } catch (e) {
                console.error('清空搜索历史失败:', e);
            }
        }

        // 显示历史搜索记录
        function showSearchHistory() {
            const historyDiv = document.getElementById('searchHistory');
            const listDiv = document.getElementById('searchHistoryList');
            const history = getSearchHistory();
            
            if (history.length === 0) {
                listDiv.innerHTML = '<div class="search-history-empty">暂无搜索历史</div>';
            } else {
                listDiv.innerHTML = history.map(item => {
                    const time = new Date(item.time);
                    const timeStr = formatTime(time);
                    return `
                        <div class="search-history-item" onclick="selectHistoryItem('${item.keyword.replace(/'/g, "\\'")}')">
                            <span class="search-history-keyword">${item.keyword}</span>
                            <span class="search-history-time">${timeStr}</span>
                        </div>
                    `;
                }).join('');
            }
            
            if (!historyDiv) {
                return;
            }
            historyDiv.style.display = 'block';
        }

        // 隐藏历史搜索记录
        function hideSearchHistory() {
            const historyDiv = document.getElementById('searchHistory');
            if (!historyDiv) {
                return;
            }
            historyDiv.style.display = 'none';
        }

        // 选择历史记录项
        function selectHistoryItem(keyword) {
            const searchInput = document.getElementById('searchInput');
            // "所有"对应空搜索
            searchInput.value = keyword === '所有' ? '' : keyword;
            hideSearchHistory();
            handleSearch();
        }

        // 格式化时间
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '刚刚';
            if (minutes < 60) return `${minutes}分钟前`;
            if (hours < 24) return `${hours}小时前`;
            if (days < 7) return `${days}天前`;
            
            return date.toLocaleDateString('zh-CN', { 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 回车搜索和事件监听
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            
            // 回车搜索
            searchInput?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // 聚焦显示历史
            searchInput?.addEventListener('focus', () => {
                showSearchHistory();
            });
            
            // 点击外部隐藏历史
            document.addEventListener('click', (e) => {
                const searchContainer = document.querySelector('.search-container');
                if (!searchContainer.contains(e.target)) {
                    hideSearchHistory();
                }
            });
        });

        // 加载搜索列表
        async function loadSearchList() {
            try {
                const response = await fetch('/api/searches');
                const searches = await response.json();
                
                const select = document.getElementById('searchSelect');
                select.innerHTML = '<option value="">选择已有搜索...</option>';
                
                if (searches.length === 0) {
                    return;
                }
                
                searches.forEach(item => {
                    const option = document.createElement('option');
                    // "all" 文件夹对应空搜索
                    const isAll = item.keyword === 'all';
                    option.value = isAll ? '' : item.keyword;
                    const displayName = isAll ? '所有' : item.keyword;
                    option.textContent = `${displayName} (${item.count}个)`;
                    
                    // 标记当前选中的搜索
                    const currentKey = currentSearch || 'all';
                    if (item.keyword === currentKey) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('加载搜索列表失败:', error);
            }
        }

        // 加载文件列表
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                
                const select = document.getElementById('fileSelect');
                if (!select) {
                    console.log('fileSelect 元素不存在，跳过加载');
                    return;
                }
                
                select.innerHTML = '';
                
                if (files.length === 0) {
                    select.innerHTML = '<option value="">没有可用数据</option>';
                    return;
                }
                
                files.forEach((file, index) => {
                    const option = document.createElement('option');
                    option.value = file.filename;
                    option.textContent = `${file.timestamp}${index === 0 ? ' (最新)' : ''}`;
                    select.appendChild(option);
                });
                
                // 不再自动加载，通过搜索功能加载数据
            } catch (error) {
                console.error('加载文件列表失败:', error);
                // 不在内容区域显示错误，避免覆盖提示信息
            }
        }

        // 加载最新数据
        async function loadLatestData() {
            try {
                const response = await fetch('/api/latest');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentData = data;
                displayData(data);
            } catch (error) {
                console.error('加载最新数据失败:', error);
                document.getElementById('content').innerHTML = 
                    '<div class="error">加载数据失败: ' + error.message + '</div>';
            }
        }

        // 加载指定文件
        async function loadFile(filename) {
            try {
                document.getElementById('content').innerHTML = 
                    '<div class="loading"><div class="loading-spinner"></div><p>正在加载数据...</p></div>';
                
                const response = await fetch('/api/data/' + filename);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentData = data;
                displayData(data);
            } catch (error) {
                console.error('加载文件失败:', error);
                document.getElementById('content').innerHTML = 
                    '<div class="error">加载数据失败: ' + error.message + '</div>';
            }
        }

        // 显示数据
        function displayData(data, sortBy = currentSortBy) {
            const startTime = performance.now(); // 性能监控
            
            // 更新统计信息（显示最新获取的数据）
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('totalCount').textContent = data.total_count || 0;
            
            // 显示数据获取时间（最新数据）
            const fetchTime = new Date(data.fetch_time);
            const now = new Date();
            const isRecent = (now - fetchTime) < 60000; // 1分钟内
            
            let timeText = fetchTime.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // 如果是刚获取的数据，添加标识
            if (isRecent) {
                timeText += ' (最新)';
            }
            
            document.getElementById('fetchTime').textContent = timeText;
            
            // 显示工作流（排序）
            let workflows = data.workflows || [];
            
            // 根据选择的维度排序
            workflows = [...workflows].sort((a, b) => {
                const aValue = a.statisticsInfo?.[sortBy] || 0;
                const bValue = b.statisticsInfo?.[sortBy] || 0;
                return bValue - aValue; // 降序排列
            });
            
            // 使用 DocumentFragment 批量渲染，提升性能
            const grid = document.createElement('div');
            grid.className = 'workflows-grid';
            const fragment = document.createDocumentFragment();
            
            workflows.forEach(workflow => {
                const card = createWorkflowCard(workflow);
                fragment.appendChild(card);
            });
            
            grid.appendChild(fragment);
            
            document.getElementById('content').innerHTML = '';
            document.getElementById('content').appendChild(grid);
            
            // 初始化懒加载
            initLazyLoad();
            
            // 观察所有需要懒加载的元素
            const lazyElements = grid.querySelectorAll('[data-src]');
            lazyElements.forEach(el => lazyLoadObserver.observe(el));
            
            // 性能监控输出
            const endTime = performance.now();
            const renderTime = (endTime - startTime).toFixed(2);
            console.log(`✅ 渲染完成: ${workflows.length} 个工作流, 耗时 ${renderTime}ms`);
            console.log(`🖼️  懒加载元素: ${lazyElements.length} 个`);
        }

        // 处理排序变化
        function handleSortChange() {
            const sortSelect = document.getElementById('sortSelect');
            currentSortBy = sortSelect.value;
            
            if (currentData) {
                displayData(currentData, currentSortBy);
            }
        }

        // 创建工作流卡片
        function createWorkflowCard(item) {
            const card = document.createElement('div');
            card.className = 'workflow-card';
            
            const preview = item.covers?.[0] || {};
            const stats = item.statisticsInfo || {};
            
            const previewUrl = preview.url || 'https://placehold.co/350x200?text=No+Preview';
            const workflowName = (item.name || '未命名工作流').replace(/'/g, "\\'");
            
            // 判断是视频还是图片
            const isVideo = previewUrl.toLowerCase().endsWith('.mp4') || 
                           previewUrl.toLowerCase().endsWith('.webm') || 
                           previewUrl.toLowerCase().endsWith('.mov');
            
            let previewHtml;
            if (isVideo) {
                // 视频预览（使用 poster 作为封面，如果有 thumbnailUri）
                const posterUrl = preview.thumbnailUri || '';
                previewHtml = `
                    <video class="workflow-preview" 
                           ${posterUrl ? `poster="${posterUrl}"` : ''}
                           data-src="${previewUrl}"
                           muted 
                           loop
                           onclick="openImageModal('${previewUrl}', '${workflowName}')"
                           onmouseover="this.play()" 
                           onmouseout="this.pause(); this.currentTime=0;">
                        <source type="video/mp4">
                    </video>`;
            } else {
                // 图片预览（懒加载）
                previewHtml = `
                    <img data-src="${previewUrl}" 
                         alt="${workflowName}" 
                         class="workflow-preview lazy-loading" 
                         onclick="openImageModal('${previewUrl}', '${workflowName}')">`;
            }
            
            card.innerHTML = `
                ${previewHtml}
                <div class="workflow-content">
                    <div class="workflow-name">${item.name || '未命名工作流'}</div>
                    <div class="workflow-stats">
                        <div class="workflow-stat">
                            <span class="workflow-stat-icon">❤️</span>
                            <span class="workflow-stat-value">${stats.likeCount || 0}</span>
                        </div>
                        <div class="workflow-stat">
                            <span class="workflow-stat-icon">🔥</span>
                            <span class="workflow-stat-value">${stats.useCount || 0}</span>
                        </div>
                        <div class="workflow-stat">
                            <span class="workflow-stat-icon">⭐</span>
                            <span class="workflow-stat-value">${stats.collectCount || 0}</span>
                        </div>
                    </div>
                    <div class="workflow-actions">
                        <a href="https://www.runninghub.cn/post/${item.id}" 
                           target="_blank" 
                           class="workflow-link">查看详情</a>
                        <a href="https://www.runninghub.cn/workflow/${item.id}" 
                           target="_blank" 
                           class="workflow-link">运行工作流</a>
                        <a href="javascript:void(0)" 
                           onclick="downloadWorkflow('${item.id}', '${(item.name || '未命名工作流').replace(/'/g, "\\'")}')"
                           class="workflow-link">保存工作流</a>
                    </div>
                </div>
            `;
            
            return card;
        }

        // 下载工作流
        async function downloadWorkflow(workflowId, workflowName) {
            try {
                // 显示加载提示
                const statusDiv = document.getElementById('refreshStatus');
                const messageDiv = document.getElementById('refreshMessage');
                statusDiv.className = 'refresh-status show';
                messageDiv.textContent = '正在获取工作流数据...';
                
                // 获取工作流详情
                const response = await fetch('/api/workflow/' + workflowId);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // 解析 workflowContent
                let workflowContent;
                if (typeof data.workflowContent === 'string') {
                    workflowContent = JSON.parse(data.workflowContent);
                } else {
                    workflowContent = data.workflowContent;
                }
                
                // 创建下载
                const blob = new Blob([JSON.stringify(workflowContent, null, 2)], { 
                    type: 'application/json' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${workflowName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 显示成功提示
                statusDiv.className = 'refresh-status show success';
                messageDiv.textContent = '✓ 工作流已保存';
                
                // 3秒后隐藏
                setTimeout(() => {
                    statusDiv.className = 'refresh-status';
                }, 3000);
                
            } catch (error) {
                console.error('下载工作流失败:', error);
                const statusDiv = document.getElementById('refreshStatus');
                const messageDiv = document.getElementById('refreshMessage');
                statusDiv.className = 'refresh-status show error';
                messageDiv.textContent = '下载失败: ' + error.message;
                
                // 3秒后隐藏
                setTimeout(() => {
                    statusDiv.className = 'refresh-status';
                }, 3000);
            }
        }

        // 刷新数据
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const statusDiv = document.getElementById('refreshStatus');
            const messageDiv = document.getElementById('refreshMessage');
            const progressFill = document.getElementById('refreshProgressFill');
            
            try {
                // 禁用按钮
                btn.disabled = true;
                
                // 显示刷新状态
                statusDiv.className = 'refresh-status show';
                messageDiv.textContent = '正在启动数据刷新...';
                progressFill.style.width = '0%';
                
                // 触发刷新
                const response = await fetch('/api/refresh', { method: 'POST' });
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                messageDiv.textContent = '数据刷新已开始...';
                
                // 开始轮询刷新状态
                refreshCheckInterval = setInterval(checkRefreshStatus, 1000);
                
            } catch (error) {
                console.error('刷新失败:', error);
                statusDiv.className = 'refresh-status show error';
                messageDiv.textContent = '刷新失败: ' + error.message;
                btn.disabled = false;
            }
        }

        // 检查刷新状态
        async function checkRefreshStatus() {
            try {
                const response = await fetch('/api/refresh/status');
                const status = await response.json();
                
                const statusDiv = document.getElementById('refreshStatus');
                const messageDiv = document.getElementById('refreshMessage');
                const progressFill = document.getElementById('refreshProgressFill');
                const btn = document.getElementById('refreshBtn');
                
                if (status.error) {
                    // 刷新出错
                    clearInterval(refreshCheckInterval);
                    statusDiv.className = 'refresh-status show error';
                    messageDiv.textContent = '刷新失败: ' + status.error;
                    btn.disabled = false;
                    
                    // 3秒后隐藏
                    setTimeout(() => {
                        statusDiv.className = 'refresh-status';
                    }, 3000);
                    
                } else if (!status.is_running && status.message.includes('完成')) {
                    // 刷新完成
                    clearInterval(refreshCheckInterval);
                    statusDiv.className = 'refresh-status show success';
                    messageDiv.textContent = `✓ "${currentSearch}" 数据刷新完成`;
                    progressFill.style.width = '100%';
                    btn.disabled = false;
                    
                    // 重新加载当前搜索的数据
                    const searchPath = currentSearch ? encodeURIComponent(currentSearch) : 'all';
                    const response = await fetch(`/api/search/${searchPath}`);
                    if (response.ok) {
                        const data = await response.json();
                        currentData = data;
                        displayData(data);
                        loadSearchList(); // 更新搜索列表
                    }
                    
                    // 3秒后隐藏
                    setTimeout(() => {
                        statusDiv.className = 'refresh-status';
                    }, 3000);
                    
                } else if (status.is_running) {
                    // 刷新进行中
                    messageDiv.textContent = status.message;
                    if (status.total > 0) {
                        const progress = (status.current / status.total) * 100;
                        progressFill.style.width = progress + '%';
                    }
                }
                
            } catch (error) {
                console.error('检查刷新状态失败:', error);
            }
        }

        // 事件监听
        document.getElementById('searchSelect').addEventListener('change', (e) => {
            const keyword = e.target.value;
            if (keyword) {
                // 切换到选中的搜索
                document.getElementById('searchInput').value = keyword;
                handleSearch();
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            // 刷新当前搜索的数据
            if (!currentSearch) {
                showSearchHint('请先选择一个搜索关键词', 'warning');
                return;
            }
            
            const btn = document.getElementById('refreshBtn');
            const statusDiv = document.getElementById('refreshStatus');
            const messageDiv = document.getElementById('refreshMessage');
            const progressFill = document.getElementById('refreshProgressFill');
            
            try {
                // 禁用按钮
                btn.disabled = true;
                
                // 显示刷新状态
                statusDiv.className = 'refresh-status show';
                messageDiv.textContent = `正在刷新 "${currentSearch}" 的数据...`;
                progressFill.style.width = '0%';
                
                // 触发抓取
                await triggerFetch(currentSearch);
                
                // 开始轮询刷新状态
                refreshCheckInterval = setInterval(checkRefreshStatus, 1000);
                
            } catch (error) {
                console.error('刷新失败:', error);
                statusDiv.className = 'refresh-status show error';
                messageDiv.textContent = '刷新失败: ' + error.message;
                btn.disabled = false;
            }
        });

        // 初始化
        async function initPage() {
            // 清空内容区域
            document.getElementById('content').innerHTML = '';
            
            // 加载文件列表（不显示内容）
            loadFileList();
            
            // 显示页码限制容器
            document.getElementById('pageLimitContainer').classList.add('show');
            
            // 查询总页数并显示
            await queryTotalPages();
            
            // 显示提示
            showSearchHint('请输入关键词搜索，或点击"搜索全部"获取所有工作流', 'warning');
        }
        
        initPage();
    </script>
</body>
</html>
