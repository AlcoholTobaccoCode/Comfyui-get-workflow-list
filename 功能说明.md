# 新增功能说明

## ✨ 新增的两个按钮功能

### 1. 查看工作流 🔍

**功能**：直接跳转到 RunningHub 的工作流页面

**实现方式**：
- 点击按钮后，在新标签页中打开 `https://www.runninghub.cn/workflow/{工作流ID}`
- 可以在线查看和编辑工作流

**使用场景**：
- 想要在线查看工作流的节点结构
- 需要在 RunningHub 平台上编辑工作流
- 查看工作流的详细配置

---

### 2. 保存工作流 💾

**功能**：下载工作流的 JSON 文件到本地

**实现方式**：
1. 点击按钮后，前端调用后端 API：`/api/workflow/{工作流ID}`
2. 后端向 RunningHub API 发送请求获取完整工作流数据
3. 解析 `workflowContent` 字段（JSON 字符串）
4. 自动下载为 `.json` 文件，文件名为工作流名称

**使用场景**：
- 保存喜欢的工作流到本地
- 导入到 ComfyUI 中使用
- 备份工作流文件

**下载的文件格式**：
```json
{
  "last_link_id": 691,
  "nodes": [...],
  "links": [...],
  "groups": [...],
  "config": {},
  "version": 0.4
}
```

---

## 🎨 界面优化

### 按钮布局
- 三个按钮横向排列，自适应宽度
- 使用 flexbox 布局，间距均匀
- 移动端自动换行

### 按钮样式
- 渐变背景色（紫色系）
- 悬停时向上浮动 2px
- 点击时有按下效果
- 统一的圆角和阴影

### 状态提示
- 下载时显示"正在获取工作流数据..."
- 成功时显示"✓ 工作流已保存"
- 失败时显示错误信息
- 3秒后自动隐藏提示

---

## 🔧 技术实现

### 后端 API

**新增接口**：`GET /api/workflow/<workflow_id>`

**功能**：获取工作流的完整数据（包含 workflowContent）

**请求示例**：
```bash
GET http://127.0.0.1:5000/api/workflow/1892584124547293185
```

**返回数据**：
```json
{
  "id": "1983248022089953281",
  "name": "换装-电商一键换装",
  "workflowContent": "{...}",  // JSON 字符串
  "preview": {...},
  "statisticsInfo": {...}
}
```

**实现逻辑**：
1. 接收工作流 ID
2. 调用 RunningHub API：`POST https://www.runninghub.cn/api/workflow/copy`
3. 传参：`{"workflowId": "xxx", "copyMode": 1}`
4. 返回完整的工作流数据

---

### 前端实现

**下载函数**：`downloadWorkflow(workflowId, workflowName)`

**核心代码**：
```javascript
async function downloadWorkflow(workflowId, workflowName) {
    // 1. 显示加载提示
    // 2. 调用后端 API 获取数据
    const response = await fetch('/api/workflow/' + workflowId);
    const data = await response.json();
    
    // 3. 解析 workflowContent（可能是字符串）
    let workflowContent;
    if (typeof data.workflowContent === 'string') {
        workflowContent = JSON.parse(data.workflowContent);
    } else {
        workflowContent = data.workflowContent;
    }
    
    // 4. 创建 Blob 并触发下载
    const blob = new Blob([JSON.stringify(workflowContent, null, 2)], { 
        type: 'application/json' 
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${workflowName}.json`;
    a.click();
    
    // 5. 清理资源
    URL.revokeObjectURL(url);
}
```

---

## 📝 使用说明

### 查看工作流
1. 在工作流卡片上找到「查看工作流」按钮
2. 点击按钮
3. 自动在新标签页打开 RunningHub 工作流页面

### 保存工作流
1. 在工作流卡片上找到「保存工作流」按钮
2. 点击按钮
3. 等待数据获取（通常 1-2 秒）
4. 浏览器自动下载 JSON 文件
5. 文件保存在浏览器默认下载目录

### 导入到 ComfyUI
1. 下载工作流 JSON 文件
2. 打开 ComfyUI
3. 点击「Load」按钮
4. 选择下载的 JSON 文件
5. 工作流自动加载到画布

---

## ⚠️ 注意事项

### Token 过期
如果下载失败，提示 Authorization 错误，需要更新 Token：

1. 打开 `app.py` 文件
2. 找到第 157 行的 `authorization` 字段
3. 替换为新的 Token（从浏览器开发者工具获取）

### 文件名处理
- 自动使用工作流名称作为文件名
- 特殊字符会被转义
- 如果名称为空，使用「未命名工作流」

### 错误处理
- 网络错误：显示"下载失败: 网络错误"
- API 错误：显示具体错误信息
- 解析错误：显示"下载失败: JSON 解析错误"

---

## 🎯 测试建议

### 测试步骤
1. 启动服务：`python app.py`
2. 打开浏览器：`http://127.0.0.1:5000`
3. 找到任意工作流卡片
4. 点击「查看工作流」，验证跳转正确
5. 点击「保存工作流」，验证下载成功
6. 检查下载的 JSON 文件格式是否正确
7. 尝试在 ComfyUI 中加载下载的文件

### 预期结果
- ✅ 查看工作流按钮正确跳转
- ✅ 保存工作流按钮成功下载
- ✅ 下载的文件可以在 ComfyUI 中正常加载
- ✅ 状态提示正确显示
- ✅ 按钮样式美观，交互流畅

---

## 🚀 后续优化建议

1. **批量下载**：添加批量下载多个工作流的功能
2. **下载历史**：记录已下载的工作流，避免重复下载
3. **预览功能**：在下载前预览工作流的节点结构
4. **分类管理**：按标签或类别组织下载的工作流
5. **云端同步**：支持将工作流同步到云端存储

---

**开发完成时间**：2025-01-29
**版本**：v1.1.0
